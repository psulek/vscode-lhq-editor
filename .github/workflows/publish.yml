name: Publish Package

on:
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  MOCHA_COLORS: '0'
  REGISTRY_URL: 'https://npm.pkg.github.com'
  PREREALSE: 1
  
jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false

      - name: Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: ${{ env.REGISTRY_URL }}
          scope: '@psulek'
          cache: 'pnpm'

      - name: Set token config
        run: |
          echo "registry=https://registry.npmjs.org/" > .npmrc
          echo "@psulek:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=$GH_READ_PACKAGES_TOKEN" >> .npmrc
        env:
          GH_READ_PACKAGES_TOKEN: ${{ secrets.GH_READ_PACKAGES_TOKEN }}

      - name: Remove preinstall script
        run: |
          node -e "let pkg=require('./package.json'); delete pkg.preinstall; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));"
          
      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          pnpm add -g vsce
        # env:
        #   GH_READ_PACKAGES_TOKEN: ${{ secrets.GH_READ_PACKAGES_TOKEN }}

      - name: Build extension
        run: |
          pnpm run compile
          
          if [ "${PREREALSE}" = "1" ]; then
            pnpm vsce publish --no-dependencies --pre-release
          else
            pnpm vsce publish --no-dependencies
          fi
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
          PREREALSE: ${{ env.PREREALSE }}


    #   - name: Update release with package link
    #     uses: actions/github-script@v7
    #     with:
    #       script: |
    #         const package_url = `https://github.com/${context.repo.owner}/${context.repo.repo}/pkgs/npm/lhq-generators`;
    #         const release = await github.rest.repos.getRelease({
    #           owner: context.repo.owner,
    #           repo: context.repo.repo,
    #           release_id: context.payload.release.id
    #         });
            
    #         const currentBody = release.data.body || '';
    #         const packageSection = `\n\n---\n\nðŸ“¦ **Package:** [View on GitHub Packages](${package_url})`;
            
    #         await github.rest.repos.updateRelease({
    #           owner: context.repo.owner,
    #           repo: context.repo.repo,
    #           release_id: context.payload.release.id,
    #           body: currentBody + packageSection
    #         });
